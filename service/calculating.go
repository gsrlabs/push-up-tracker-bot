package service

import (
	"math"
)
	
const (
	// –ë–∞–∑–æ–≤—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è
	MinDailyPushups       = 40   // –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –¥–Ω–µ–≤–Ω–∞—è –Ω–æ—Ä–º–∞
	MaxDailyPushups       = 250  // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –±–µ–∑–æ–ø–∞—Å–Ω—ã–π –ø—Ä–µ–¥–µ–ª
	AbsoluteMaxPushups    = 500  // –ê–±—Å–æ–ª—é—Ç–Ω—ã–π –º–∞–∫—Å–∏–º—É–º –¥–ª—è –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª–æ–≤

	// –£—Ä–æ–≤–Ω–∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ (–º–∞–∫—Å. –æ—Ç–∂–∏–º–∞–Ω–∏—è –∑–∞ –ø–æ–¥—Ö–æ–¥)
	StartingThreshold     = 10   // ‚â§10 - —Å—Ç–∞—Ä—Ç–æ–≤—ã–π —É—Ä–æ–≤–µ–Ω—å
	BeginnerThreshold     = 20   // ‚â§20 - –Ω–∞—á–∞–ª—å–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å
	IntermediateThreshold = 30   // ‚â§30 - —Å—Ä–µ–¥–Ω–∏–π —É—Ä–æ–≤–µ–Ω—å
	AdvancedThreshold     = 40   // ‚â§40 - –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π
	ExpertThreshold       = 50   // ‚â§51+ - —ç–∫—Å–ø–µ—Ä—Ç

	// –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –Ω–æ—Ä–º—ã
	BaseCoefficient      = 5.0   // –°—Ç–∞—Ä—Ç–æ–≤—ã–π –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç
	CoefficientStep      = 0.025 // –®–∞–≥ —É–º–µ–Ω—å—à–µ–Ω–∏—è –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–∞
	MinCoefficient       = 2.5   // –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç

	// –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ ACSM
	ACSMIntensityRatio   = 0.7   // 70% –æ—Ç –º–∞–∫—Å–∏–º—É–º–∞ –∑–∞ –ø–æ–¥—Ö–æ–¥
	RecoveryHours        = 48    // –ß–∞—Å—ã –æ—Ç–¥—ã—Ö–∞ –º–µ–∂–¥—É —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞–º–∏
)

// CalculateDailyNorm —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç –¥–Ω–µ–≤–Ω—É—é –Ω–æ—Ä–º—É —Å —É–º–µ–Ω—å—à–∞—é—â–∏–º—Å—è –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–æ–º
// –ê—Ä–≥—É–º–µ–Ω—Ç—ã:
//   maxReps - –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç–∂–∏–º–∞–Ω–∏–π –∑–∞ –æ–¥–∏–Ω –ø–æ–¥—Ö–æ–¥
// –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
//   –¥–Ω–µ–≤–Ω—É—é –Ω–æ—Ä–º—É (—Ü–µ–ª–æ–µ —á–∏—Å–ª–æ, –∫—Ä–∞—Ç–Ω–æ–µ 5)
func CalculateDailyNorm(maxReps int) int {
	// –ó–∞—â–∏—Ç–∞ –æ—Ç –Ω–µ—Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π
	if maxReps <= 0 {
		return MinDailyPushups
	}
	if maxReps > 100 {
		return MaxDailyPushups
	}

	// –ü—Ä–æ–≥—Ä–µ—Å—Å–∏–≤–Ω–∞—è —Ñ–æ—Ä–º—É–ª–∞ —Å —É–º–µ–Ω—å—à–∞—é—â–∏–º—Å—è –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–æ–º
	coefficient := getSmoothCoefficient(maxReps)
	rawNorm := float64(maxReps) * coefficient

	// –û–∫—Ä—É–≥–ª–µ–Ω–∏–µ –¥–æ –±–ª–∏–∂–∞–π—à–µ–≥–æ –∫—Ä–∞—Ç–Ω–æ–≥–æ 5
	norm := int(math.Round(rawNorm/5)) * 5

	// –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –≥—Ä–∞–Ω–∏—á–Ω—ã—Ö —É—Å–ª–æ–≤–∏–π
	return clamp(norm, MinDailyPushups, MaxDailyPushups)
}


func getSmoothCoefficient(maxReps int) float64 {
    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –±–∞–∑–æ–≤—ã–π –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å—Ä–µ–¥–Ω–∏—Ö –∑–Ω–∞—á–µ–Ω–∏–π ACSM
	// –°–æ–≥–ª–∞—Å–Ω–æ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º ACSM (American College of Sports Medicine)
    var base float64
    
    switch {
    case maxReps <= StartingThreshold:  // –ù–æ–≤–∏—á–∫–∏ (ACSM: 30-50)
        base = 4  // (30+50)/2 / 10 = 4
    case maxReps <= BeginnerThreshold:  // –ù–∞—á–∞–ª—å–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å (ACSM: 40-60)
        base = 2.5  // (40+60)/2 / 20 = 2.5
    case maxReps <= IntermediateThreshold:  // –°—Ä–µ–¥–Ω–∏–π —É—Ä–æ–≤–µ–Ω—å (ACSM: 60-80)
        base = 2.33 // (60+80)/2 / 30 ‚âà 2.33
    case maxReps <= AdvancedThreshold:  // –ò–Ω—Ç–µ–Ω—Å–∏–≤–Ω—ã–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ (ACSM: 80-120)
        base = 2.5  // (80+120)/2 / 40 = 2.5
    case maxReps <= ExpertThreshold:  // –ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ (ACSM: 120-150)
        base = 2.7  // (120+150)/2 / 50 = 2.7
    default:            // –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—ã (ACSM: 150-250)
        base = 2.5  // (150+250)/2 / 80 ‚âà 2.5 (–¥–ª—è maxReps=80)
    }
    
    // –ü–ª–∞–≤–Ω–æ–µ —É–º–µ–Ω—å—à–µ–Ω–∏–µ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–∞ –º–µ–∂–¥—É –≥—Ä–∞–Ω–∏—Ü–∞–º–∏
    smoothBase := BaseCoefficient - CoefficientStep*float64(maxReps)
    
    // –ö–æ–º–ø—Ä–æ–º–∏—Å—Å –º–µ–∂–¥—É –ø–ª–∞–≤–Ω–æ—Å—Ç—å—é –∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ–º ACSM
    finalCoeff := (base + smoothBase) / 2
    
    return math.Max(math.Min(finalCoeff, BaseCoefficient), MinCoefficient)
}

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –¥–∏–∞–ø–∞–∑–æ–Ω–∞
func clamp(value, min, max int) int {
	if value < min {
		return min
	}
	if value > max {
		return max
	}
	return value
}


// GetUserRank –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ä–∞–Ω–≥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –µ–≥–æ maxReps
func GetUserRank(maxReps int) string {
    switch {
    case maxReps <= 0:
        return "üí§ –°–æ–Ω–Ω–∞—è –º—É—Ö–∞"
    case maxReps <= 5:
        return "üå± –†–æ—Å—Ç–æ–∫ —Å–∏–ª—ã"
    case maxReps <= 10:
        return "üêú –¢—Ä—É–¥—è–≥–∞"
    case maxReps <= 15:
        return "üöÄ –°—Ç–∞–∂—ë—Ä –∫–æ—Å–º–æ—Å–∞"
    case maxReps <= 20:
        return "üöÄ –†–∞–∫–µ—Ç–∞-–Ω–æ—Å–∏—Ç–µ–ª—å"
    case maxReps <= 25:
        return "‚öîÔ∏è –†—ã—Ü–∞—Ä—å —Å–≤–µ—Ç–∞"
    case maxReps <= 30:
        return "üõ°Ô∏è –ù–µ–ø—Ä–æ–±–∏–≤–∞–µ–º—ã–π"
    case maxReps <= 40:
        return "‚ö° –ì—Ä–æ–∑–∞ –ø–æ–ª–∞"
    case maxReps <= 50:
        return "üèπ –ê–¥–µ–ø—Ç —É–ø–æ—Ä—Å—Ç–≤–∞"
    case maxReps <= 75:
        return "üåå –ü–æ–±–µ–¥–∏—Ç–µ–ª—å –≥—Ä–∞–≤–∏—Ç–∞—Ü–∏–∏"
    case maxReps <= 100:
        return "üåü –õ–µ–≥–µ–Ω–¥–∞ –≥–æ—Ä–∏–∑–æ–Ω—Ç–æ–≤"
    default:
        return "üöÄ –í–õ–ê–°–¢–ï–õ–ò–ù –û–¢–ñ–ò–ú–ê–ù–ò–ô"
    }
}

// CalculateNextTarget —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç, –Ω–∞ —Å–∫–æ–ª—å–∫–æ –º–∏–Ω–∏–º—É–º –Ω—É–∂–Ω–æ —É–≤–µ–ª–∏—á–∏—Ç—å maxReps –Ω–∞ –Ω–æ–≤–æ–π –Ω–µ–¥–µ–ª–µ.
// –ê—Ä–≥—É–º–µ–Ω—Ç:
//   currentMaxReps - —Ç–µ–∫—É—â–∏–π –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å –∑–∞ –æ–¥–∏–Ω –ø–æ–¥—Ö–æ–¥
// –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
//   —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º–æ–µ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ —É–≤–µ–ª–∏—á–µ–Ω–∏–µ (—Ü–µ–ª–æ–µ —á–∏—Å–ª–æ)
func CalculateNextTarget(currentMaxReps int) int {
    // –ó–∞—â–∏—Ç–∞ –æ—Ç –Ω–µ—Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π
    if currentMaxReps < 0 {
        return 1
    }

    // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —à–∞–≥–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å–∏–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–µ–∫—É—â–µ–≥–æ —É—Ä–æ–≤–Ω—è
    switch {
    case currentMaxReps < 5: 
        // –£—Ä–æ–≤–µ–Ω—å: –ù–∞—á–∏–Ω–∞—é—â–∏–π (–æ—á–µ–Ω—å –Ω–∏–∑–∫–∏–π)
        return 1
    case currentMaxReps >= 5 && currentMaxReps < 15:
        // –£—Ä–æ–≤–µ–Ω—å: –†–∞–∑–≤–∏–≤–∞—é—â–∏–π—Å—è (–Ω–∏–∑–∫–∏–π)
        return 2
    case currentMaxReps >= 15 && currentMaxReps < 30:
        // –£—Ä–æ–≤–µ–Ω—å: –°—Ä–µ–¥–Ω–∏–π
        return 3
    case currentMaxReps >= 30 && currentMaxReps < 50:
        // –£—Ä–æ–≤–µ–Ω—å: –ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π
        return 2 // –£–º–µ–Ω—å—à–∞–µ–º —à–∞–≥, —Ç–∞–∫ –∫–∞–∫ –ø—Ä–æ–≥—Ä–µ—Å—Å –∑–∞–º–µ–¥–ª—è–µ—Ç—Å—è
    case currentMaxReps >= 50 && currentMaxReps < 100:
        // –£—Ä–æ–≤–µ–Ω—å: –û–ø—ã—Ç–Ω—ã–π
        return 1
    default:
        // –£—Ä–æ–≤–µ–Ω—å: –ú–∞—Å—Ç–µ—Ä (100+)
        // –ù–∞ –æ—á–µ–Ω—å –≤—ã—Å–æ–∫–æ–º —É—Ä–æ–≤–Ω–µ —Ä–µ–≥—É–ª—è—Ä–Ω–æ–µ —É–≤–µ–ª–∏—á–µ–Ω–∏–µ –Ω–µ–¥–µ–ª—å–Ω–æ–≥–æ –º–∞–∫—Å–∏–º—É–º–∞ –∑–∞—Ç—Ä—É–¥–Ω–∏—Ç–µ–ª—å–Ω–æ.
        // –¶–µ–ª–µ—Å–æ–æ–±—Ä–∞–∑–Ω–µ–µ —Ä–∞–±–æ—Ç–∞—Ç—å –Ω–∞–¥ –¥—Ä—É–≥–∏–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ (–≤–∑—Ä—ã–≤–Ω–∞—è —Å–∏–ª–∞, –≤–∞—Ä–∏–∞—Ü–∏–∏).
        return 0
    }
}